<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>阵营人物介绍</title>
    <!-- 引入Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入Font Awesome -->
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    
    <!-- 配置Tailwind自定义颜色和字体 -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        defender: {
                            primary: '#1a365d',
                            secondary: '#d69e2e',
                            light: '#e2e8f0',
                            dark: '#172a45'
                        },
                        rebel: {
                            primary: '#742a2a',
                            secondary: '#2d3748',
                            light: '#f56565',
                            dark: '#4a1a1a'
                        }
                    },
                    fontFamily: {
                        ancient: ['"Ma Shan Zheng"', '"Noto Serif SC"', 'serif']
                    }
                }
            }
        }
    </script>
    
    <!-- 引入中文字体 -->
    <link href="https://fonts.googleapis.com/css2?family=Ma+Shan+Zheng&family=Noto+Serif+SC:wght@400;700&display=swap" rel="stylesheet">
    
    <!-- 自定义工具类 -->
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .text-shadow {
                text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
            }
            .bg-texture {
                background-image: url('https://images.unsplash.com/photo-1519751138087-5bf79df62d5b?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=2070&q=80');
                background-size: cover;
                background-attachment: fixed;
                background-position: center;
                background-blend-mode: overlay;
            }
            .card-hover {
                transition: all 0.3s ease;
            }
            .card-hover:hover {
                transform: translateY(-5px);
                box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            }
            .fade-in {
                animation: fadeIn 0.5s ease-in-out;
            }
            @keyframes fadeIn {
                from { opacity: 0; }
                to { opacity: 1; }
            }
            .slide-in {
                animation: slideIn 0.5s ease-out;
            }
            @keyframes slideIn {
                from { transform: translateX(50px); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
        }
    </style>
</head>
<body class="bg-gray-100 bg-texture">
    <!-- 导航栏 -->
    <header class="sticky top-0 z-50 bg-white/80 backdrop-blur-md shadow-md transition-all duration-300">
        <nav class="container mx-auto px-4 py-4 flex flex-wrap items-center justify-between">
            <div class="flex items-center">
                <i class="fa fa-shield text-3xl mr-3 text-defender-primary"></i>
                <h1 class="text-2xl md:text-3xl font-ancient font-bold text-gray-800">阵营录</h1>
            </div>
            
            <div class="hidden md:flex space-x-6 mt-4 md:mt-0">
                <button id="defender-btn" class="nav-btn active py-2 px-4 rounded-md font-medium transition-all duration-300 bg-defender-primary text-white" 
                        data-section="characters" data-faction="defender">
                    镇守使
                </button>
                <button id="rebel-btn" class="nav-btn py-2 px-4 rounded-md font-medium transition-all duration-300 bg-rebel-primary/10 text-rebel-primary hover:bg-rebel-primary hover:text-white"
                        data-section="characters" data-faction="rebel">
                    乱臣贼子
                </button>
                <button id="battles-btn" class="nav-btn py-2 px-4 rounded-md font-medium transition-all duration-300 bg-defender-primary/10 text-defender-primary hover:bg-defender-primary hover:text-white"
                        data-section="battles">
                    <i class="fa fa-trophy mr-1"></i> 镇守使战绩
                </button>
                <button id="admin-btn" class="py-2 px-4 rounded-md font-medium bg-gray-200 text-gray-700 hover:bg-gray-300 transition-all duration-300">
                    <i class="fa fa-cog mr-1"></i> 管理
                </button>
            </div>
            
            <!-- 移动端菜单按钮 -->
            <button id="mobile-menu-btn" class="md:hidden text-gray-700 focus:outline-none">
                <i class="fa fa-bars text-2xl"></i>
            </button>
        </nav>
        
        <!-- 移动端菜单 -->
        <div id="mobile-menu" class="hidden md:hidden bg-white border-t">
            <div class="container mx-auto px-4 py-2 flex flex-col space-y-3">
                <button id="mobile-defender-btn" class="mobile-nav-btn active py-2 px-4 rounded-md font-medium transition-all duration-300 text-left bg-defender-primary text-white"
                        data-section="characters" data-faction="defender">
                    镇守使
                </button>
                <button id="mobile-rebel-btn" class="mobile-nav-btn py-2 px-4 rounded-md font-medium transition-all duration-300 text-left bg-rebel-primary/10 text-rebel-primary hover:bg-rebel-primary hover:text-white"
                        data-section="characters" data-faction="rebel">
                    乱臣贼子
                </button>
                <button id="mobile-battles-btn" class="mobile-nav-btn py-2 px-4 rounded-md font-medium transition-all duration-300 text-left bg-defender-primary/10 text-defender-primary hover:bg-defender-primary hover:text-white"
                        data-section="battles">
                    <i class="fa fa-trophy mr-1"></i> 镇守使战绩
                </button>
                <button id="mobile-admin-btn" class="py-2 px-4 rounded-md font-medium bg-gray-200 text-gray-700 hover:bg-gray-300 transition-all duration-300 text-left">
                    <i class="fa fa-cog mr-1"></i> 管理
                </button>
            </div>
        </div>
    </header>

    <main class="container mx-auto px-4 py-8">
        <!-- 人物展示模块 -->
        <section id="characters-module">
            <!-- 阵营介绍部分 -->
            <section id="faction-intro" class="mb-12 transition-all duration-500">
                <div class="bg-white/90 rounded-xl shadow-lg p-6 md:p-8 backdrop-blur-sm">
                    <h2 id="faction-title" class="text-3xl md:text-4xl font-ancient font-bold mb-4 text-defender-primary">镇守使阵营</h2>
                    <p id="faction-description" class="text-lg text-gray-700 leading-relaxed">
                        镇守使乃维护天下秩序之栋梁，以守护苍生为己任，秉承正义之道，镇守四方疆土，抵御内外之乱。他们坚守正道，恪守誓言，以铁腕手段惩治邪恶，以仁德之心安抚百姓。
                    </p>
                </div>
            </section>
            
            <!-- 人物展示部分 -->
            <section id="characters-section" class="mb-16 transition-all duration-500">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-2xl font-ancient font-bold text-defender-primary">镇守使成员</h3>
                    <div class="flex space-x-2">
                        <button id="prev-btn" class="p-2 rounded-full bg-defender-primary/10 text-defender-primary hover:bg-defender-primary hover:text-white transition-all duration-300">
                            <i class="fa fa-chevron-left"></i>
                        </button>
                        <button id="next-btn" class="p-2 rounded-full bg-defender-primary/10 text-defender-primary hover:bg-defender-primary hover:text-white transition-all duration-300">
                            <i class="fa fa-chevron-right"></i>
                        </button>
                    </div>
                </div>
                
                <!-- 人物卡片容器 -->
                <div id="characters-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- 人物卡片会通过JavaScript动态生成 -->
                </div>
                
                <!-- 分页指示器 -->
                <div id="pagination-indicators" class="flex justify-center mt-8 space-x-2">
                    <!-- 分页指示器会通过JavaScript动态生成 -->
                </div>
            </section>
            
            <!-- 加入条件部分 -->
            <section id="join-conditions" class="mb-16 transition-all duration-500">
                <div class="bg-white/90 rounded-xl shadow-lg p-6 md:p-8 backdrop-blur-sm">
                    <h3 class="text-2xl md:text-3xl font-ancient font-bold mb-6 text-defender-primary">加入镇守使条件</h3>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- 加入条件会通过JavaScript动态生成 -->
                    </div>
                    
                    <div class="mt-8 text-center">
                        <button id="apply-btn" class="inline-block bg-defender-primary hover:bg-defender-dark text-white font-bold py-3 px-8 rounded-full transition-all duration-300 transform hover:scale-105">
                            申请加入
                        </button>
                    </div>
                </div>
            </section>
        </section>
        
        <!-- 镇守使战绩模块 -->
        <section id="battles-module" class="hidden">
            <!-- 战绩介绍部分 -->
            <section class="mb-12">
                <div class="bg-white/90 rounded-xl shadow-lg p-6 md:p-8 backdrop-blur-sm">
                    <h2 class="text-3xl md:text-4xl font-ancient font-bold mb-4 text-defender-primary">镇守使战绩</h2>
                    <p class="text-lg text-gray-700 leading-relaxed">
                        此处记录了镇守使平定乱臣贼子的辉煌战绩。每一场胜利都彰显了正义终将战胜邪恶的真理，每一次交锋都展现了镇守使维护天下安定的决心。
                    </p>
                </div>
            </section>
            
            <!-- 被击败的乱臣贼子列表 -->
            <section class="mb-16">
                <h3 class="text-2xl font-ancient font-bold text-defender-primary mb-6">被击败的乱臣贼子</h3>
                
                <div id="defeated-rebels-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- 被击败的乱臣贼子卡片会通过JavaScript动态生成 -->
                </div>
            </section>
            
            <!-- 战绩详情模态框 (默认隐藏) -->
            <div id="battle-details-modal" class="fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-50 hidden">
                <div class="bg-white rounded-xl shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-hidden flex flex-col transform transition-all duration-300 scale-95 opacity-0" id="battle-modal-content">
                    <div class="p-6 border-b flex justify-between items-center">
                        <h3 class="text-2xl font-ancient font-bold text-defender-primary" id="battle-modal-title">战绩详情</h3>
                        <button id="close-battle-modal" class="text-gray-500 hover:text-gray-700">
                            <i class="fa fa-times text-xl"></i>
                        </button>
                    </div>
                    
                    <div class="flex-1 overflow-y-auto p-6" id="battle-details-content">
                        <!-- 战绩详情会通过JavaScript动态生成 -->
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- 页脚 -->
    <footer class="bg-gray-800 text-white py-8">
        <div class="container mx-auto px-4">
            <div class="flex flex-col md:flex-row justify-between items-center">
                <div class="mb-6 md:mb-0">
                    <div class="flex items-center">
                        <i class="fa fa-shield text-2xl mr-2 text-defender-secondary"></i>
                        <h2 class="text-xl font-ancient font-bold">阵营录</h2>
                    </div>
                    <p class="text-gray-400 mt-2">记录天下英雄，划分正邪两派</p>
                </div>
                
                <div class="flex space-x-6">
                    <a href="#" class="text-gray-400 hover:text-white transition-colors duration-300">
                        <i class="fa fa-book text-xl"></i>
                        <span class="ml-1">阵营历史</span>
                    </a>
                    <a href="#" class="text-gray-400 hover:text-white transition-colors duration-300">
                        <i class="fa fa-map-marker text-xl"></i>
                        <span class="ml-1">据点分布</span>
                    </a>
                    <a href="#" class="text-gray-400 hover:text-white transition-colors duration-300">
                        <i class="fa fa-envelope text-xl"></i>
                        <span class="ml-1">联系我们</span>
                    </a>
                </div>
            </div>
            
            <div class="border-t border-gray-700 mt-6 pt-6 text-center text-gray-400 text-sm">
                &copy; 2023 阵营录 - 天下英雄尽在此中
            </div>
        </div>
    </footer>
    
    <!-- 申请加入模态框 -->
    <div id="apply-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md mx-4 transform transition-all duration-300 scale-95 opacity-0" id="modal-content">
            <div class="p-6 border-b">
                <div class="flex justify-between items-center">
                    <h3 class="text-2xl font-ancient font-bold text-defender-primary">申请加入镇守使</h3>
                    <button id="close-modal" class="text-gray-500 hover:text-gray-700">
                        <i class="fa fa-times text-xl"></i>
                    </button>
                </div>
            </div>
            
            <div class="p-6">
                <form id="apply-form">
                    <div class="mb-4">
                        <label for="name" class="block text-gray-700 font-medium mb-2">姓名</label>
                        <input type="text" id="name" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-defender-primary/50" required>
                    </div>
                    
                    <div class="mb-4">
                        <label for="skill" class="block text-gray-700 font-medium mb-2">专长</label>
                        <input type="text" id="skill" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-defender-primary/50" required>
                    </div>
                    
                    <div class="mb-4">
                        <label for="reason" class="block text-gray-700 font-medium mb-2">加入理由</label>
                        <textarea id="reason" rows="4" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-defender-primary/50" required></textarea>
                    </div>
                    
                    <button type="submit" class="w-full bg-defender-primary hover:bg-defender-dark text-white font-bold py-3 px-4 rounded-lg transition-all duration-300">
                        提交申请
                    </button>
                </form>
            </div>
        </div>
    </div>
    
    <!-- 管理员登录模态框 -->
    <div id="admin-login-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md mx-4 transform transition-all duration-300 scale-95 opacity-0" id="admin-login-content">
            <div class="p-6 border-b">
                <div class="flex justify-between items-center">
                    <h3 class="text-2xl font-ancient font-bold text-gray-800">管理员登录</h3>
                    <button id="close-admin-login" class="text-gray-500 hover:text-gray-700">
                        <i class="fa fa-times text-xl"></i>
                    </button>
                </div>
            </div>
            
            <div class="p-6">
                <form id="admin-login-form">
                    <div class="mb-4">
                        <label for="admin-username" class="block text-gray-700 font-medium mb-2">用户名</label>
                        <input type="text" id="admin-username" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-500/50" required>
                    </div>
                    
                    <div class="mb-6">
                        <label for="admin-password" class="block text-gray-700 font-medium mb-2">密码</label>
                        <input type="password" id="admin-password" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-500/50" required>
                    </div>
                    
                    <div class="text-red-500 text-sm mb-4 hidden" id="login-error">
                        用户名或密码错误
                    </div>
                    
                    <button type="submit" class="w-full bg-gray-700 hover:bg-gray-800 text-white font-bold py-3 px-4 rounded-lg transition-all duration-300">
                        登录
                    </button>
                </form>
            </div>
        </div>
    </div>
    
    <!-- 管理员后台 -->
    <div id="admin-panel" class="fixed inset-0 bg-white z-50 transform translate-x-full transition-transform duration-300 ease-in-out">
        <div class="h-full flex flex-col">
            <div class="p-4 border-b flex justify-between items-center">
                <h2 class="text-2xl font-ancient font-bold text-gray-800">人物管理</h2>
                <div class="flex items-center space-x-3">
                    <button id="logout-btn" class="py-1 px-3 text-sm bg-red-100 text-red-700 rounded hover:bg-red-200 transition-colors">
                        <i class="fa fa-sign-out mr-1"></i> 退出登录
                    </button>
                    <button id="close-admin-panel" class="p-2 text-gray-500 hover:text-gray-700">
                        <i class="fa fa-times text-xl"></i>
                    </button>
                </div>
            </div>
            
            <div class="flex flex-1 overflow-hidden">
                <!-- 左侧导航 -->
                <div class="w-64 border-r bg-gray-50 overflow-y-auto">
                    <div class="p-4">
                        <h3 class="font-bold text-gray-700 mb-3">选择阵营</h3>
                        <div class="space-y-1">
                            <button class="admin-faction-btn w-full text-left py-2 px-3 rounded bg-defender-primary text-white" data-faction="defender">
                                镇守使
                            </button>
                            <button class="admin-faction-btn w-full text-left py-2 px-3 rounded bg-gray-200 text-gray-700 hover:bg-gray-300" data-faction="rebel">
                                乱臣贼子
                            </button>
                        </div>
                        
                        <!-- 添加新人物按钮 -->
                        <button id="add-character-btn" class="mt-4 w-full py-2 px-3 rounded bg-green-100 text-green-700 hover:bg-green-200 transition-colors text-left">
                            <i class="fa fa-plus mr-1"></i> 添加新人物
                        </button>
                    </div>
                    
                    <!-- 新增数据管理部分 -->
                    <div class="p-4 border-t">
                        <h3 class="font-bold text-gray-700 mb-3">数据管理</h3>
                        <button id="save-data-btn" class="w-full py-2 px-3 rounded bg-blue-100 text-blue-700 hover:bg-blue-200 transition-colors text-left mb-2">
                            <i class="fa fa-download mr-1"></i> 保存数据
                        </button>
                        <button id="sync-data-btn" class="w-full py-2 px-3 rounded bg-green-100 text-green-700 hover:bg-green-200 transition-colors text-left">
                            <i class="fa fa-refresh mr-1"></i> 从GitHub同步
                        </button>
                        <p class="text-xs text-gray-500 mt-2">点击保存数据后，将下载JSON文件。请将此文件复制到项目的data文件夹中。</p>
                    </div>
                    
                    <div class="p-4 border-t">
                        <h3 class="font-bold text-gray-700 mb-3">人物列表</h3>
                        <div class="space-y-1" id="admin-characters-list">
                            <!-- 人物列表会通过JavaScript动态生成 -->
                        </div>
                    </div>
                </div>
                
                <!-- 右侧内容区 -->
                <div class="flex-1 overflow-y-auto p-6" id="admin-character-form-container">
                    <h3 class="text-xl font-bold text-gray-800 mb-6" id="form-title">编辑人物信息</h3>
                    
                    <form id="character-form">
                        <input type="hidden" id="character-id">
                        <input type="hidden" id="character-faction">
                        <input type="hidden" id="is-new-character" value="false">
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                            <div>
                                <label for="character-name" class="block text-gray-700 font-medium mb-2">姓名</label>
                                <input type="text" id="character-name" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-500/50" required>
                            </div>
                            
                            <div>
                                <label for="character-title" class="block text-gray-700 font-medium mb-2">职位</label>
                                <input type="text" id="character-title" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-500/50" required>
                            </div>
                        </div>
                        
                        <div class="mb-6">
                            <label for="character-description" class="block text-gray-700 font-medium mb-2">人物描述</label>
                            <textarea id="character-description" rows="4" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-500/50" required></textarea>
                        </div>
                        
                        <div class="mb-6">
                            <label for="character-tags" class="block text-gray-700 font-medium mb-2">标签 (用逗号分隔)</label>
                            <input type="text" id="character-tags" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-500/50" placeholder="例如: 剑法,谋略,领导力" required>
                        </div>
                        
                        <div class="mb-6">
                            <label class="block text-gray-700 font-medium mb-2">肖像图片</label>
                            <div class="flex flex-col md:flex-row gap-6">
                                <div class="w-full md:w-1/3">
                                    <div class="border-2 border-dashed border-gray-300 rounded-lg p-4 text-center hover:border-gray-500 transition-colors">
                                        <img id="character-image-preview" src="https://images.unsplash.com/photo-1534528741775-53994a69daeb?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=764&q=80" alt="人物肖像预览" class="w-full h-48 object-cover rounded mb-2">
                                        <p class="text-sm text-gray-500 mb-2">当前图片</p>
                                        <button type="button" id="remove-image-btn" class="text-sm text-red-500 hover:text-red-700">
                                            <i class="fa fa-trash mr-1"></i> 移除图片
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="w-full md:w-2/3 flex flex-col justify-center">
                                    <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:border-gray-500 transition-colors cursor-pointer" id="upload-area">
                                        <i class="fa fa-cloud-upload text-3xl text-gray-400 mb-2"></i>
                                        <p class="text-gray-500 mb-2">点击或拖拽图片到此处上传</p>
                                        <p class="text-xs text-gray-400">支持 JPG, PNG 格式，最大 5MB</p>
                                        <input type="file" id="image-upload" accept="image/jpeg, image/png" class="hidden">
                                    </div>
                                    
                                    <div class="mt-4" id="image-url-option">
                                        <p class="text-sm text-gray-600 mb-2">或输入图片URL:</p>
                                        <div class="flex">
                                            <input type="url" id="character-image-url" class="flex-1 px-4 py-2 border border-gray-300 rounded-l-lg focus:outline-none focus:ring-2 focus:ring-gray-500/50" placeholder="https://example.com/image.jpg">
                                            <button type="button" id="use-url-btn" class="bg-gray-700 hover:bg-gray-800 text-white px-4 rounded-r-lg transition-colors">
                                                使用
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 战绩管理部分 (仅对乱臣贼子显示) -->
                        <div id="battle-records-section" class="mb-6 hidden">
                            <div class="flex justify-between items-center mb-4">
                                <h4 class="text-lg font-bold text-gray-800">战绩记录</h4>
                                <button type="button" id="add-battle-record-btn" class="py-1 px-3 text-sm bg-green-100 text-green-700 rounded hover:bg-green-200 transition-colors">
                                    <i class="fa fa-plus mr-1"></i> 添加战绩
                                </button>
                            </div>
                            
                            <div id="battle-records-container" class="space-y-6">
                                <!-- 战绩记录会通过JavaScript动态生成 -->
                            </div>
                        </div>
                        
                        <div class="flex justify-end space-x-3">
                            <button type="button" id="cancel-edit-btn" class="px-6 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-100 transition-colors">
                                取消
                            </button>
                            <button type="submit" class="px-6 py-2 bg-gray-700 hover:bg-gray-800 text-white rounded-lg transition-colors">
                                保存更改
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 战绩编辑模态框 -->
    <div id="battle-record-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-3xl max-h-[90vh] overflow-hidden flex flex-col transform transition-all duration-300 scale-95 opacity-0" id="battle-modal-form-content">
            <div class="p-6 border-b flex justify-between items-center">
                <h3 class="text-xl font-ancient font-bold text-gray-800" id="battle-form-title">编辑战绩</h3>
                <button id="close-battle-modal-form" class="text-gray-500 hover:text-gray-700">
                    <i class="fa fa-times text-xl"></i>
                </button>
            </div>
            
            <div class="flex-1 overflow-y-auto p-6">
                <form id="battle-record-form">
                    <input type="hidden" id="battle-rebel-id">
                    <input type="hidden" id="battle-record-index" value="-1">
                    
                    <div class="mb-4">
                        <label for="battle-title" class="block text-gray-700 font-medium mb-2">战役名称</label>
                        <input type="text" id="battle-title" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-500/50" required>
                    </div>
                    
                    <div class="mb-4">
                        <label for="battle-date" class="block text-gray-700 font-medium mb-2">日期</label>
                        <input type="text" id="battle-date" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-500/50" placeholder="例如: 天启三年三月" required>
                    </div>
                    
                    <div class="mb-4">
                        <label for="battle-hero" class="block text-gray-700 font-medium mb-2">镇守使功臣</label>
                        <input type="text" id="battle-hero" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-500/50" placeholder="例如: 李青云、苏沐雪" required>
                    </div>
                    
                    <div class="mb-6">
                        <label for="battle-description" class="block text-gray-700 font-medium mb-2">战役描述</label>
                        <textarea id="battle-description" rows="4" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-500/50" required></textarea>
                    </div>
                    
                    <div class="mb-6">
                        <label class="block text-gray-700 font-medium mb-2">战役图片</label>
                        <div id="battle-images-container" class="space-y-4">
                            <!-- 战役图片会通过JavaScript动态生成 -->
                        </div>
                        <button type="button" id="add-battle-image-btn" class="mt-3 py-1 px-3 text-sm bg-blue-100 text-blue-700 rounded hover:bg-blue-200 transition-colors">
                            <i class="fa fa-plus mr-1"></i> 添加图片
                        </button>
                    </div>
                    
                    <div class="flex justify-end space-x-3">
                        <button type="button" id="cancel-battle-edit-btn" class="px-6 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-100 transition-colors">
                            取消
                        </button>
                        <button type="submit" class="px-6 py-2 bg-gray-700 hover:bg-gray-800 text-white rounded-lg transition-colors">
                            保存战绩
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // 当前页码、阵营和模块
        let currentPage = 0;
        let totalPages = 1; // 总页数，初始为1，将根据人物数量动态计算
        const charactersPerPage = 3; // 每页显示3个角色
        let currentFaction = 'defender'; // 默认阵营
        let currentModule = 'characters'; // 默认模块：人物展示
        let isAdminLoggedIn = false; // 管理员登录状态
        
        // GitHub数据URL
        const GITHUB_DATA_URL = 'https://raw.githubusercontent.com/5wdee/-/main/data/campaign-data.json';
        
        // 人物数据（将从GitHub加载）
        let charactersData = {
            defender: [],
            rebel: []
        };
        
        // 阵营数据
        const factionsData = {
            defender: {
                title: "镇守使阵营",
                description: "镇守使乃维护天下秩序之栋梁，以守护苍生为己任，秉承正义之道，镇守四方疆土，抵御内外之乱。他们坚守正道，恪守誓言，以铁腕手段惩治邪恶，以仁德之心安抚百姓。",
                joinTitle: "加入镇守使条件",
                joinConditions: [
                    { icon: "fa-heart", title: "心怀正义", desc: "需有济世救民之心，以维护天下苍生为己任，不谋私利，不徇私情。" },
                    { icon: "fa-balance-scale", title: "品行端正", desc: "需品行端正，无不良记录，恪守道德准则，不为非作歹，不欺凌弱小。" },
                    { icon: "fa-shield", title: "有一技之长", desc: "需有一技之长，无论是武功、智谋、医术还是其他特殊技能，能为镇守使贡献力量。" },
                    { icon: "fa-handshake-o", title: "宣誓效忠", desc: "需宣誓效忠镇守使，遵守镇守使规章，服从命令，即使牺牲生命也在所不辞。" }
                ],
                applyBtnText: "申请加入"
            },
            rebel: {
                title: "乱臣贼子阵营",
                description: "乱臣贼子乃挑战现有秩序之势力，他们或因不满现状，或因野心驱使，意图颠覆现有格局。他们行事不拘一格，无视常规礼法，以实力为尊，虽被称为贼子，却也有自己的信念与追求。",
                joinTitle: "加入乱臣贼子条件",
                joinConditions: [
                    { icon: "fa-bolt", title: "胆识过人", desc: "需有敢于挑战权威的勇气，不拘泥于世俗礼教，敢于打破常规。" },
                    { icon: "fa-diamond", title: "实力至上", desc: "需有过人实力，无论是武功、智谋或其他特殊能力，能在乱世中立足。" },
                    { icon: "fa-bomb", title: "狠辣无情", desc: "需心狠手辣，行事果断，不妇人之仁，为达目的可以不择手段。" },
                    { icon: "fa-handshake-o", title: "绝对忠诚", desc: "需对盟主绝对忠诚，遵守阵营规矩，服从命令，共同对抗镇守使。" }
                ],
                applyBtnText: "投奔我们"
            }
        };
        
        // 从GitHub加载数据
        async function loadDataFromGitHub() {
            try {
                console.log('正在从GitHub加载数据...');
                // 添加时间戳防止缓存
                const response = await fetch(GITHUB_DATA_URL + '?t=' + new Date().getTime());
                
                if (!response.ok) {
                    throw new Error(`HTTP错误! 状态: ${response.status}`);
                }
                
                const data = await response.json();
                charactersData = data.characters || data;
                
                // 保存到本地存储
                localStorage.setItem('charactersData', JSON.stringify(charactersData));
                localStorage.setItem('charactersDataTimestamp', new Date().getTime().toString());
                
                console.log('成功从GitHub加载数据');
                return true;
            } catch (error) {
                console.error('从GitHub加载数据失败:', error);
                
                // 尝试从本地存储加载
                const localData = localStorage.getItem('charactersData');
                if (localData) {
                    try {
                        charactersData = JSON.parse(localData);
                        console.log('使用本地存储的数据');
                        return true;
                    } catch (e) {
                        console.error('解析本地数据失败:', e);
                    }
                }
                
                // 如果都没有数据，使用默认数据
                console.log('使用默认数据');
                charactersData = {
                    defender: [
                        {
                            id: 1,
                            name: "李青云",
                            title: "统领",
                            image: "https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=687&q=80",
                            description: "镇守使最高统领，剑法卓绝，智勇双全，曾单枪匹马平定边境之乱。",
                            tags: ["剑法", "谋略", "领导力"]
                        },
                        {
                            id: 2,
                            name: "苏沐雪",
                            title: "谋士",
                            image: "https://images.unsplash.com/photo-1487412720507-e7ab37603c6f?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=1171&q=80",
                            description: "镇守使首席谋士，神机妙算，足不出户便知天下事，为镇守使献无数良策。",
                            tags: ["智谋", "计策", "洞察"]
                        }
                    ],
                    rebel: [
                        {
                            id: 3,
                            name: "萧天邪",
                            title: "盟主",
                            image: "https://images.unsplash.com/photo-1560250097-0b93528c311a?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=687&q=80",
                            description: "乱臣贼子盟主，武功盖世，野心勃勃，欲颠覆现有秩序，建立新的天下格局。",
                            tags: ["野心", "武功", "权谋"],
                            battleRecords: [
                                {
                                    id: 1,
                                    title: "黑风岭之战",
                                    date: "天启三年三月",
                                    description: "萧天邪率五千叛军进攻黑风岭，李青云仅带三百精兵迎敌，以奇计破敌，萧天邪大败而逃，身中三箭，险些被俘。",
                                    images: [
                                        "https://images.unsplash.com/photo-1519751138087-5bf79df62d5b?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=2070&q=80",
                                        "https://images.unsplash.com/photo-1519751138087-5bf79df62d5b?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=2070&q=80"
                                    ],
                                    defenderHero: "李青云"
                                }
                            ]
                        }
                    ]
                };
                
                return false;
            }
        }
        
        // 保存数据到localStorage
        function saveCharactersData() {
            localStorage.setItem('charactersData', JSON.stringify(charactersData));
            localStorage.setItem('charactersDataTimestamp', new Date().getTime().toString());
        }
        
        // 计算总页数
        function calculateTotalPages() {
            const characterCount = charactersData[currentFaction].length;
            totalPages = Math.ceil(characterCount / charactersPerPage);
            if (totalPages === 0) totalPages = 1; // 至少有一页
        }
        
        // 保存数据到文件功能
        function saveDataToFile() {
            // 获取当前数据
            const dataToSave = {
                characters: charactersData,
                factions: factionsData,
                lastUpdated: new Date().toISOString(),
                version: "1.0"
            };
            
            // 转换为JSON字符串
            const jsonString = JSON.stringify(dataToSave, null, 2);
            
            // 创建Blob对象
            const blob = new Blob([jsonString], { type: 'application/json' });
            
            // 创建下载链接
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'campaign-data.json';
            
            // 触发下载
            document.body.appendChild(a);
            a.click();
            
            // 清理
            setTimeout(() => {
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }, 100);
            
            // 显示成功消息
            alert('数据已成功导出为 campaign-data.json 文件。\n\n请将此文件复制到GitHub项目的data文件夹中，以便其他人可以看到您的更改。');
        }
        
        // 生成新的人物ID
        function generateNewId() {
            // 收集所有现有ID
            let allIds = [];
            Object.values(charactersData).forEach(faction => {
                faction.forEach(character => {
                    allIds.push(character.id);
                });
            });
            
            // 返回最大ID + 1
            return allIds.length > 0 ? Math.max(...allIds) + 1 : 1;
        }
        
        // 生成新的战绩ID
        function generateNewBattleId() {
            // 收集所有现有战绩ID
            let allBattleIds = [];
            charactersData.rebel.forEach(rebel => {
                if (rebel.battleRecords) {
                    rebel.battleRecords.forEach(record => {
                        allBattleIds.push(record.id);
                    });
                }
            });
            
            // 返回最大ID + 1，如果没有则返回1
            return allBattleIds.length > 0 ? Math.max(...allBattleIds) + 1 : 1;
        }
        
        // 初始化页面
        async function init() {
            // 首先加载数据
            await loadDataFromGitHub();
            
            // 导航按钮事件 - 切换模块和阵营
            document.getElementById('defender-btn').addEventListener('click', () => switchModuleAndFaction('characters', 'defender'));
            document.getElementById('rebel-btn').addEventListener('click', () => switchModuleAndFaction('characters', 'rebel'));
            document.getElementById('battles-btn').addEventListener('click', () => switchModuleAndFaction('battles'));
            
            document.getElementById('mobile-defender-btn').addEventListener('click', () => {
                switchModuleAndFaction('characters', 'defender');
                toggleMobileMenu();
            });
            document.getElementById('mobile-rebel-btn').addEventListener('click', () => {
                switchModuleAndFaction('characters', 'rebel');
                toggleMobileMenu();
            });
            document.getElementById('mobile-battles-btn').addEventListener('click', () => {
                switchModuleAndFaction('battles');
                toggleMobileMenu();
            });
            
            // 移动端菜单切换
            document.getElementById('mobile-menu-btn').addEventListener('click', toggleMobileMenu);
            
            // 分页按钮事件
            document.getElementById('prev-btn').addEventListener('click', showPrevPage);
            document.getElementById('next-btn').addEventListener('click', showNextPage);
            
            // 申请加入按钮事件
            document.getElementById('apply-btn').addEventListener('click', openModal);
            document.getElementById('close-modal').addEventListener('click', closeModal);
            
            // 点击模态框外部关闭
            document.getElementById('apply-modal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeModal();
                }
            });
            
            // 表单提交事件
            document.getElementById('apply-form').addEventListener('submit', function(e) {
                e.preventDefault();
                // 模拟提交成功
                alert('申请已提交，我们会尽快与您联系！');
                closeModal();
                this.reset();
            });
            
            // 管理员按钮事件
            document.getElementById('admin-btn').addEventListener('click', openAdminLogin);
            document.getElementById('mobile-admin-btn').addEventListener('click', function() {
                openAdminLogin();
                toggleMobileMenu();
            });
            
            // 管理员登录相关事件
            document.getElementById('close-admin-login').addEventListener('click', closeAdminLogin);
            document.getElementById('admin-login-form').addEventListener('submit', handleAdminLogin);
            
            // 管理员面板事件
            document.getElementById('close-admin-panel').addEventListener('click', closeAdminPanel);
            document.getElementById('logout-btn').addEventListener('click', handleLogout);
            
            // 修复：添加新人物按钮事件监听
            document.getElementById('add-character-btn').addEventListener('click', function() {
                prepareAddNewCharacter();
            });
            
            document.querySelectorAll('.admin-faction-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const faction = this.getAttribute('data-faction');
                    switchAdminFaction(faction);
                });
            });
            
            // 保存数据按钮事件
            document.getElementById('save-data-btn').addEventListener('click', saveDataToFile);
            
            // 同步数据按钮事件
            document.getElementById('sync-data-btn').addEventListener('click', async function() {
                const success = await loadDataFromGitHub();
                if (success) {
                    alert('数据已从GitHub同步成功！');
                    // 刷新当前视图
                    if (currentModule === 'characters') {
                        renderCharacterCards();
                        updateJoinConditions();
                    } else if (currentModule === 'battles') {
                        renderDefeatedRebels();
                    }
                } else {
                    alert('数据同步失败，请检查网络连接或GitHub URL设置。');
                }
            });
            
            // 人物图片上传事件
            const uploadArea = document.getElementById('upload-area');
            const imageUpload = document.getElementById('image-upload');
            
            uploadArea.addEventListener('click', () => imageUpload.click());
            
            imageUpload.addEventListener('change', handleImageUpload);
            
            // 拖拽上传
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('border-gray-500', 'bg-gray-50');
            });
            
            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('border-gray-500', 'bg-gray-50');
            });
            
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('border-gray-500', 'bg-gray-50');
                
                if (e.dataTransfer.files.length) {
                    imageUpload.files = e.dataTransfer.files;
                    handleImageUpload();
                }
            });
            
            // 图片URL输入事件
            document.getElementById('use-url-btn').addEventListener('click', useImageUrl);
            document.getElementById('remove-image-btn').addEventListener('click', removeImage);
            
            // 人物表单事件
            document.getElementById('character-form').addEventListener('submit', saveOrCreateCharacter);
            document.getElementById('cancel-edit-btn').addEventListener('click', function() {
                // 取消编辑时返回主页面或人物列表
                const isNew = document.getElementById('is-new-character').value === 'true';
                if (isNew) {
                    // 如果是新增状态，取消后显示当前阵营的第一个人物
                    const currentFaction = document.getElementById('character-faction').value;
                    if (charactersData[currentFaction].length > 0) {
                        editCharacter(currentFaction, 0);
                    } else {
                        // 如果没有人物，清空表单
                        clearCharacterForm();
                    }
                } else {
                    closeAdminPanel();
                }
            });
            
            // 战绩详情模态框事件
            document.getElementById('close-battle-modal').addEventListener('click', closeBattleDetailsModal);
            document.getElementById('battle-details-modal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeBattleDetailsModal();
                }
            });
            
            // 战绩编辑相关事件
            document.getElementById('add-battle-record-btn').addEventListener('click', openAddBattleRecordModal);
            document.getElementById('close-battle-modal-form').addEventListener('click', closeBattleRecordModal);
            document.getElementById('cancel-battle-edit-btn').addEventListener('click', closeBattleRecordModal);
            document.getElementById('battle-record-form').addEventListener('submit', saveBattleRecord);
            document.getElementById('add-battle-image-btn').addEventListener('click', addBattleImageField);
            
            // 初始化页面显示
            calculateTotalPages();
            renderCharacterCards();
            updateJoinConditions();
            renderDefeatedRebels();
            updateNavButtons();
            renderAdminCharactersList('defender');
        }
        
        // 切换模块和阵营
        function switchModuleAndFaction(module, faction = null) {
            currentModule = module;
            
            // 如果指定了阵营，则更新当前阵营
            if (faction) {
                currentFaction = faction;
                currentPage = 0; // 切换阵营时重置到第一页
                calculateTotalPages(); // 重新计算总页数
            }
            
            // 显示选中的模块，隐藏其他模块
            if (module === 'characters') {
                document.getElementById('characters-module').classList.remove('hidden');
                document.getElementById('battles-module').classList.add('hidden');
                
                // 更新人物模块内容
                document.getElementById('faction-title').textContent = factionsData[currentFaction].title;
                document.getElementById('faction-description').textContent = factionsData[currentFaction].description;
                document.querySelector('#join-conditions h3').textContent = factionsData[currentFaction].joinTitle;
                document.getElementById('apply-btn').textContent = factionsData[currentFaction].applyBtnText;
                
                updateJoinConditions();
                renderCharacterCards();
                updatePageIndicators();
            } else if (module === 'battles') {
                document.getElementById('characters-module').classList.add('hidden');
                document.getElementById('battles-module').classList.remove('hidden');
                
                // 渲染战绩模块中的乱臣贼子列表
                renderDefeatedRebels();
            }
            
            // 更新导航按钮样式
            updateNavButtons();
        }
        
        // 渲染被击败的乱臣贼子列表
        function renderDefeatedRebels() {
            const container = document.getElementById('defeated-rebels-container');
            container.innerHTML = '';
            
            // 只显示有战绩记录的乱臣贼子
            const rebelsWithBattles = charactersData.rebel.filter(rebel => 
                rebel.battleRecords && rebel.battleRecords.length > 0
            );
            
            rebelsWithBattles.forEach((rebel, index) => {
                const card = document.createElement('div');
                card.className = `card-hover bg-white rounded-xl shadow-md overflow-hidden fade-in cursor-pointer`;
                card.setAttribute('data-id', rebel.id);
                card.innerHTML = `
                    <div class="relative">
                        <img src="${rebel.image}" alt="${rebel.name}肖像" class="w-full h-64 object-cover" onerror="this.src='https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=687&q=80'; this.onerror=null;">
                        <div class="absolute top-4 right-4 bg-rebel-secondary text-white text-sm py-1 px-3 rounded-full">
                            ${rebel.title}
                        </div>
                        <div class="absolute top-4 left-4 bg-red-600 text-white text-sm py-1 px-3 rounded-full">
                            <i class="fa fa-flag-checkered mr-1"></i> 已击败
                        </div>
                    </div>
                    <div class="p-6">
                        <h4 class="text-xl font-bold mb-2 text-rebel-primary">${rebel.name}</h4>
                        <p class="text-gray-600 mb-4 line-clamp-2">${rebel.description}</p>
                        <div class="flex justify-between items-center">
                            <div class="flex flex-wrap gap-2">
                                ${rebel.tags.map(tag => `
                                    <span class="text-xs bg-rebel-primary/10 text-rebel-primary py-1 px-2 rounded-full">${tag}</span>
                                `).join('')}
                            </div>
                            <span class="text-sm text-gray-500">
                                <i class="fa fa-history mr-1"></i> ${rebel.battleRecords.length} 次败绩
                            </span>
                        </div>
                    </div>
                `;
                
                // 点击卡片查看战绩详情
                card.addEventListener('click', () => showBattleDetails(rebel.id));
                
                container.appendChild(card);
            });
        }
        
        // 显示战绩详情
        function showBattleDetails(rebelId) {
            const rebel = charactersData.rebel.find(r => r.id === rebelId);
            if (!rebel || !rebel.battleRecords) return;
            
            const modal = document.getElementById('battle-details-modal');
            const modalContent = document.getElementById('battle-modal-content');
            const detailsContent = document.getElementById('battle-details-content');
            
            // 设置模态框标题
            document.getElementById('battle-modal-title').textContent = `${rebel.name} 败绩记录`;
            
            // 生成战绩详情HTML
            let detailsHtml = `
                <div class="mb-8">
                    <div class="flex items-center mb-4">
                        <img src="${rebel.image}" alt="${rebel.name}肖像" class="w-20 h-20 rounded-full object-cover mr-4 border-2 border-rebel-primary" onerror="this.src='https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=687&q=80'; this.onerror=null;">
                        <div>
                            <h4 class="text-2xl font-bold text-rebel-primary">${rebel.name}</h4>
                            <p class="text-gray-600">${rebel.title} | ${rebel.tags.join(' · ')}</p>
                        </div>
                    </div>
                    <p class="text-gray-700">${rebel.description}</p>
                </div>
                
                <div class="border-t pt-6">
                    <h5 class="text-xl font-bold mb-6 text-defender-primary">败绩记录 (${rebel.battleRecords.length})</h5>
                    
                    <div class="space-y-8">
            `;
            
            // 添加每条战绩记录
            rebel.battleRecords.forEach((record, index) => {
                detailsHtml += `
                    <div class="slide-in" style="animation-delay: ${index * 0.1}s">
                        <h6 class="text-lg font-bold mb-2">${record.title}</h6>
                        <p class="text-gray-500 text-sm mb-3">${record.date} | 镇守使功臣: ${record.defenderHero}</p>
                        <p class="text-gray-700 mb-4">${record.description}</p>
                        
                        <div class="grid grid-cols-1 md:grid-cols-${record.images.length > 1 ? 2 : 1} gap-4 mb-2">
                            ${record.images.map(img => `
                                <div class="rounded-lg overflow-hidden shadow">
                                    <img src="${img}" alt="${record.title}战景" class="w-full h-48 object-cover hover:scale-105 transition-transform duration-500" onerror="this.src='https://images.unsplash.com/photo-1519751138087-5bf79df62d5b?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=2070&q=80'; this.onerror=null;">
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            });
            
            detailsHtml += `
                    </div>
                </div>
            `;
            
            // 设置详情内容
            detailsContent.innerHTML = detailsHtml;
            
            // 显示模态框并添加动画
            modal.classList.remove('hidden');
            setTimeout(() => {
                modalContent.classList.remove('scale-95', 'opacity-0');
                modalContent.classList.add('scale-100', 'opacity-100');
            }, 10);
        }
        
        // 关闭战绩详情模态框
        function closeBattleDetailsModal() {
            const modal = document.getElementById('battle-details-modal');
            const modalContent = document.getElementById('battle-modal-content');
            
            // 添加关闭动画
            modalContent.classList.remove('scale-100', 'opacity-100');
            modalContent.classList.add('scale-95', 'opacity-0');
            
            // 动画结束后隐藏模态框
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 300);
        }
        
        // 更新加入条件
        function updateJoinConditions() {
            const conditionsContainer = document.querySelector('#join-conditions .grid');
            conditionsContainer.innerHTML = '';
            
            factionsData[currentFaction].joinConditions.forEach(condition => {
                const conditionElement = document.createElement('div');
                conditionElement.className = 'flex items-start';
                conditionElement.innerHTML = `
                    <div class="flex-shrink-0 w-10 h-10 rounded-full bg-${currentFaction}-primary/10 flex items-center justify-center text-${currentFaction}-primary mr-4">
                        <i class="fa ${condition.icon}"></i>
                    </div>
                    <div>
                        <h4 class="text-xl font-bold mb-2">${condition.title}</h4>
                        <p class="text-gray-600">${condition.desc}</p>
                    </div>
                `;
                conditionsContainer.appendChild(conditionElement);
            });
        }
        
        // 渲染人物卡片
        function renderCharacterCards() {
            const container = document.getElementById('characters-container');
            container.innerHTML = '';
            
            // 每页显示3个角色
            const startIndex = currentPage * charactersPerPage;
            const endIndex = Math.min(startIndex + charactersPerPage, charactersData[currentFaction].length);
            
            for (let i = startIndex; i < endIndex; i++) {
                const character = charactersData[currentFaction][i];
                const card = document.createElement('div');
                card.className = `character-card card-hover bg-white rounded-xl shadow-md overflow-hidden fade-in`;
                card.setAttribute('data-index', i);
                card.innerHTML = `
                    <div class="relative">
                        <img src="${character.image}" alt="${character.name}肖像" class="w-full h-64 object-cover" onerror="this.src='https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=687&q=80'; this.onerror=null;">
                        <div class="absolute top-4 right-4 bg-${currentFaction}-secondary text-white text-sm py-1 px-3 rounded-full">
                            ${character.title}
                        </div>
                    </div>
                    <div class="p-6">
                        <h4 class="text-xl font-bold mb-2 text-${currentFaction}-primary">${character.name}</h4>
                        <p class="text-gray-600 mb-4">${character.description}</p>
                        <div class="flex flex-wrap gap-2">
                            ${character.tags.map(tag => `
                                <span class="text-xs bg-${currentFaction}-primary/10 text-${currentFaction}-primary py-1 px-2 rounded-full">${tag}</span>
                            `).join('')}
                        </div>
                    </div>
                `;
                container.appendChild(card);
            }
            
            // 更新分页指示器
            updatePageIndicators();
        }
        
        // 显示上一页
        function showPrevPage() {
            if (currentPage > 0) {
                showPage(currentPage - 1);
            }
        }
        
        // 显示下一页
        function showNextPage() {
            if (currentPage < totalPages - 1) {
                showPage(currentPage + 1);
            }
        }
        
        // 显示指定页
        function showPage(page) {
            currentPage = page;
            renderCharacterCards();
            updatePageIndicators();
        }
        
        // 更新分页指示器
        function updatePageIndicators() {
            const container = document.getElementById('pagination-indicators');
            container.innerHTML = '';
            
            for (let i = 0; i < totalPages; i++) {
                const indicator = document.createElement('button');
                indicator.className = `page-indicator w-3 h-3 rounded-full ${i === currentPage ? 'bg-' + currentFaction + '-primary' : 'bg-gray-300'} transition-all duration-300`;
                indicator.setAttribute('data-page', i);
                indicator.addEventListener('click', function() {
                    const page = parseInt(this.getAttribute('data-page'));
                    showPage(page);
                });
                container.appendChild(indicator);
            }
        }
        
        // 更新导航按钮样式
        function updateNavButtons() {
            // 桌面端导航
            document.querySelectorAll('.nav-btn').forEach(btn => {
                const section = btn.getAttribute('data-section');
                const faction = btn.getAttribute('data-faction');
                
                if (section === 'battles') {
                    // 战绩按钮样式
                    if (currentModule === 'battles') {
                        btn.className = `nav-btn py-2 px-4 rounded-md font-medium transition-all duration-300 bg-defender-primary text-white`;
                    } else {
                        btn.className = `nav-btn py-2 px-4 rounded-md font-medium transition-all duration-300 bg-defender-primary/10 text-defender-primary hover:bg-defender-primary hover:text-white`;
                    }
                } else {
                    // 阵营按钮样式
                    if (currentModule === 'characters' && faction === currentFaction) {
                        btn.className = `nav-btn active py-2 px-4 rounded-md font-medium transition-all duration-300 bg-${faction}-primary text-white`;
                    } else {
                        btn.className = `nav-btn py-2 px-4 rounded-md font-medium transition-all duration-300 bg-${faction}-primary/10 text-${faction}-primary hover:bg-${faction}-primary hover:text-white`;
                    }
                }
            });
            
            // 移动端导航
            document.querySelectorAll('.mobile-nav-btn').forEach(btn => {
                const section = btn.getAttribute('data-section');
                const faction = btn.getAttribute('data-faction');
                
                if (section === 'battles') {
                    // 战绩按钮样式
                    if (currentModule === 'battles') {
                        btn.className = `mobile-nav-btn py-2 px-4 rounded-md font-medium transition-all duration-300 bg-defender-primary text-white`;
                    } else {
                        btn.className = `mobile-nav-btn py-2 px-4 rounded-md font-medium transition-all duration-300 bg-defender-primary/10 text-defender-primary hover:bg-defender-primary hover:text-white`;
                    }
                } else {
                    // 阵营按钮样式
                    if (currentModule === 'characters' && faction === currentFaction) {
                        btn.className = `mobile-nav-btn active py-2 px-4 rounded-md font-medium transition-all duration-300 bg-${faction}-primary text-white`;
                    } else {
                        btn.className = `mobile-nav-btn py-2 px-4 rounded-md font-medium transition-all duration-300 bg-${faction}-primary/10 text-${faction}-primary hover:bg-${faction}-primary hover:text-white`;
                    }
                }
            });
            
            // 只有在人物模块时才显示分页按钮
            if (currentModule === 'characters') {
                // 更新翻页按钮
                document.getElementById('prev-btn').className = `p-2 rounded-full bg-${currentFaction}-primary/10 text-${currentFaction}-primary hover:bg-${currentFaction}-primary hover:text-white transition-all duration-300 ${currentPage === 0 ? 'opacity-50 cursor-not-allowed' : ''}`;
                document.getElementById('next-btn').className = `p-2 rounded-full bg-${currentFaction}-primary/10 text-${currentFaction}-primary hover:bg-${currentFaction}-primary hover:text-white transition-all duration-300 ${currentPage === totalPages - 1 ? 'opacity-50 cursor-not-allowed' : ''}`;
                
                // 更新标题颜色
                document.getElementById('faction-title').className = `text-3xl md:text-4xl font-ancient font-bold mb-4 text-${currentFaction}-primary`;
                document.querySelector('#characters-section h3').className = `text-2xl font-ancient font-bold text-${currentFaction}-primary`;
                document.querySelector('#join-conditions h3').className = `text-2xl md:text-3xl font-ancient font-bold mb-6 text-${currentFaction}-primary`;
                document.getElementById('apply-btn').className = `inline-block bg-${currentFaction}-primary hover:bg-${currentFaction}-dark text-white font-bold py-3 px-8 rounded-full transition-all duration-300 transform hover:scale-105`;
            }
        }
        
        // 切换移动端菜单
        function toggleMobileMenu() {
            const mobileMenu = document.getElementById('mobile-menu');
            mobileMenu.classList.toggle('hidden');
        }
        
        // 打开模态框
        function openModal() {
            const modal = document.getElementById('apply-modal');
            const modalContent = document.getElementById('modal-content');
            
            modal.classList.remove('hidden');
            // 触发动画
            setTimeout(() => {
                modalContent.classList.remove('scale-95', 'opacity-0');
                modalContent.classList.add('scale-100', 'opacity-100');
            }, 10);
            
            // 更新模态框标题颜色
            document.querySelector('#modal-content h3').className = `text-2xl font-ancient font-bold text-${currentFaction}-primary`;
            document.querySelector('#apply-form button[type="submit"]').className = `w-full bg-${currentFaction}-primary hover:bg-${currentFaction}-dark text-white font-bold py-3 px-4 rounded-lg transition-all duration-300`;
        }
        
        // 关闭模态框
        function closeModal() {
            const modal = document.getElementById('apply-modal');
            const modalContent = document.getElementById('modal-content');
            
            // 触发动画
            modalContent.classList.remove('scale-100', 'opacity-100');
            modalContent.classList.add('scale-95', 'opacity-0');
            
            // 动画结束后隐藏
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 300);
        }
        
        // 管理员登录相关函数
        function openAdminLogin() {
            if (isAdminLoggedIn) {
                openAdminPanel();
                return;
            }
            
            const modal = document.getElementById('admin-login-modal');
            const modalContent = document.getElementById('admin-login-content');
            
            // 确保模态框可见
            modal.style.display = 'flex';
            setTimeout(() => {
                modalContent.classList.remove('scale-95', 'opacity-0');
                modalContent.classList.add('scale-100', 'opacity-100');
            }, 10);
        }
        
        function closeAdminLogin() {
            const modal = document.getElementById('admin-login-modal');
            const modalContent = document.getElementById('admin-login-content');
            
            // 触发动画
            modalContent.classList.remove('scale-100', 'opacity-100');
            modalContent.classList.add('scale-95', 'opacity-0');
            
            // 动画结束后隐藏模态框
            setTimeout(() => {
                modal.style.display = 'none';
                document.getElementById('login-error').classList.add('hidden');
                document.getElementById('admin-login-form').reset();
            }, 300);
        }
        
        function handleAdminLogin(e) {
            e.preventDefault(); // 防止表单默认提交行为
            
            // 获取输入值
            const username = document.getElementById('admin-username').value.trim();
            const password = document.getElementById('admin-password').value.trim();
            
            // 验证
            if (username === 'zssnb' && password === 'zstx') {
                isAdminLoggedIn = true;
                
                // 先关闭登录模态框，再打开管理面板
                const modal = document.getElementById('admin-login-modal');
                const modalContent = document.getElementById('admin-login-content');
                
                modalContent.classList.remove('scale-100', 'opacity-100');
                modalContent.classList.add('scale-95', 'opacity-0');
                
                setTimeout(() => {
                    modal.style.display = 'none';
                    openAdminPanel(); // 登录成功后打开管理面板
                }, 300);
            } else {
                // 显示错误信息
                const errorElement = document.getElementById('login-error');
                errorElement.classList.remove('hidden');
                
                // 3秒后自动隐藏错误信息
                setTimeout(() => {
                    errorElement.classList.add('hidden');
                }, 3000);
            }
        }
        
        // 处理退出登录
        function handleLogout() {
            if (confirm('确定要退出登录吗？')) {
                isAdminLoggedIn = false;
                closeAdminPanel();
            }
        }
        
        function openAdminPanel() {
            const adminPanel = document.getElementById('admin-panel');
            adminPanel.classList.remove('translate-x-full');
            
            // 默认选中第一个人物
            if (charactersData.defender.length > 0) {
                editCharacter('defender', 0);
            }
        }
        
        function closeAdminPanel() {
            const adminPanel = document.getElementById('admin-panel');
            adminPanel.classList.add('translate-x-full');
            
            // 刷新当前模块的显示
            if (currentModule === 'characters') {
                calculateTotalPages();
                renderCharacterCards();
            } else if (currentModule === 'battles') {
                renderDefeatedRebels();
            }
        }
        
        function switchAdminFaction(faction) {
            // 更新按钮样式
            document.querySelectorAll('.admin-faction-btn').forEach(btn => {
                const btnFaction = btn.getAttribute('data-faction');
                if (btnFaction === faction) {
                    btn.className = `admin-faction-btn w-full text-left py-2 px-3 rounded bg-${faction}-primary text-white`;
                } else {
                    btn.className = `admin-faction-btn w-full text-left py-2 px-3 rounded bg-gray-200 text-gray-700 hover:bg-gray-300`;
                }
            });
            
            // 渲染人物列表
            renderAdminCharactersList(faction);
            
            // 显示或隐藏战绩管理部分
            if (faction === 'rebel') {
                document.getElementById('battle-records-section').classList.remove('hidden');
            } else {
                document.getElementById('battle-records-section').classList.add('hidden');
            }
            
            // 默认选中第一个人物
            if (charactersData[faction].length > 0) {
                editCharacter(faction, 0);
            } else {
                // 如果该阵营没有人物，准备添加新人物
                prepareAddNewCharacter(faction);
            }
        }
        
        // 准备添加新人物
        function prepareAddNewCharacter(faction = null) {
            // 如果没有指定阵营，使用当前选中的阵营
            const currentFaction = faction || document.querySelector('.admin-faction-btn.bg-defender-primary, .admin-faction-btn.bg-rebel-primary').getAttribute('data-faction');
            
            // 更新表单标题
            document.getElementById('form-title').textContent = '添加新人物';
            
            // 清空表单
            clearCharacterForm();
            
            // 设置表单状态为新增
            document.getElementById('is-new-character').value = 'true';
            document.getElementById('character-faction').value = currentFaction;
            
            // 更新保存按钮文本
            document.querySelector('#character-form button[type="submit"]').textContent = '添加人物';
            
            // 清空战绩记录容器
            document.getElementById('battle-records-container').innerHTML = '';
            
            // 显示或隐藏战绩管理部分
            if (currentFaction === 'rebel') {
                document.getElementById('battle-records-section').classList.remove('hidden');
            } else {
                document.getElementById('battle-records-section').classList.add('hidden');
            }
        }
        
        // 清空人物表单
        function clearCharacterForm() {
            document.getElementById('character-id').value = '';
            document.getElementById('character-name').value = '';
            document.getElementById('character-title').value = '';
            document.getElementById('character-description').value = '';
            document.getElementById('character-tags').value = '';
            
            const defaultImage = 'https://images.unsplash.com/photo-1534528741775-53994a69daeb?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=764&q=80';
            document.getElementById('character-image-preview').src = defaultImage;
            document.getElementById('character-image-url').value = defaultImage;
            document.getElementById('image-upload').value = '';
        }
        
        function renderAdminCharactersList(faction) {
            const listContainer = document.getElementById('admin-characters-list');
            listContainer.innerHTML = '';
            
            charactersData[faction].forEach((character, index) => {
                const item = document.createElement('button');
                item.className = `w-full text-left py-2 px-3 rounded hover:bg-gray-200 transition-colors ${index === 0 ? 'bg-gray-200 font-medium' : ''}`;
                item.setAttribute('data-faction', faction);
                item.setAttribute('data-index', index);
                item.innerHTML = `
                    ${character.name}
                    <div class="flex items-center justify-end mt-1">
                        <button type="button" class="delete-character-btn text-xs text-red-500 hover:text-red-700 ml-2" 
                                data-faction="${faction}" data-index="${index}">
                            <i class="fa fa-trash-o"></i> 删除
                        </button>
                    </div>
                `;
                
                item.addEventListener('click', function(e) {
                    // 防止点击删除按钮时触发编辑事件
                    if (!e.target.closest('.delete-character-btn')) {
                        // 更新列表项样式
                        listContainer.querySelectorAll('button').forEach(btn => {
                            btn.className = 'w-full text-left py-2 px-3 rounded hover:bg-gray-200 transition-colors';
                        });
                        this.className = 'w-full text-left py-2 px-3 rounded bg-gray-200 font-medium transition-colors';
                        
                        // 编辑选中的人物
                        const f = this.getAttribute('data-faction');
                        const i = parseInt(this.getAttribute('data-index'));
                        editCharacter(f, i);
                    }
                });
                
                listContainer.appendChild(item);
            });
            
            // 添加删除按钮事件监听
            document.querySelectorAll('.delete-character-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation(); // 阻止事件冒泡
                    
                    const faction = this.getAttribute('data-faction');
                    const index = parseInt(this.getAttribute('data-index'));
                    const characterName = charactersData[faction][index].name;
                    
                    if (confirm(`确定要删除 ${characterName} 吗？`)) {
                        // 从数组中删除人物
                        charactersData[faction].splice(index, 1);
                        
                        // 保存数据
                        saveCharactersData();
                        
                        // 重新计算总页数
                        calculateTotalPages();
                        
                        // 重新渲染人物列表
                        renderAdminCharactersList(faction);
                        
                        // 如果删除后还有人物，显示第一个人物
                        if (charactersData[faction].length > 0) {
                            editCharacter(faction, 0);
                        } else {
                            // 如果没有人物了，准备添加新人物
                            prepareAddNewCharacter(faction);
                        }
                    }
                });
            });
        }
        
        function editCharacter(faction, index) {
            const character = charactersData[faction][index];
            
            // 更新表单标题
            document.getElementById('form-title').textContent = '编辑人物信息';
            
            // 填充表单数据
            document.getElementById('character-id').value = character.id;
            document.getElementById('character-faction').value = faction;
            document.getElementById('character-name').value = character.name;
            document.getElementById('character-title').value = character.title;
            document.getElementById('character-description').value = character.description;
            document.getElementById('character-tags').value = character.tags.join(',');
            document.getElementById('character-image-preview').src = character.image;
            document.getElementById('character-image-url').value = character.image;
            
            // 设置表单状态为编辑
            document.getElementById('is-new-character').value = 'false';
            
            // 更新保存按钮文本
            document.querySelector('#character-form button[type="submit"]').textContent = '保存更改';
            
            // 显示或隐藏战绩管理部分
            if (faction === 'rebel') {
                document.getElementById('battle-records-section').classList.remove('hidden');
                renderBattleRecords(character.id); // 渲染该乱臣贼子的战绩记录
            } else {
                document.getElementById('battle-records-section').classList.add('hidden');
            }
        }
        
        // 渲染战绩记录
        function renderBattleRecords(rebelId) {
            const container = document.getElementById('battle-records-container');
            container.innerHTML = '';
            
            const rebel = charactersData.rebel.find(r => r.id === rebelId);
            if (!rebel || !rebel.battleRecords || rebel.battleRecords.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <i class="fa fa-folder-open-o text-4xl mb-2"></i>
                        <p>暂无战绩记录，点击"添加战绩"按钮添加</p>
                    </div>
                `;
                return;
            }
            
            // 为每条战绩记录创建条目
            rebel.battleRecords.forEach((record, index) => {
                const recordElement = document.createElement('div');
                recordElement.className = 'border rounded-lg p-4 hover:shadow-md transition-shadow';
                recordElement.innerHTML = `
                    <div class="flex justify-between items-start mb-3">
                        <h5 class="font-bold text-gray-800">${record.title}</h5>
                        <div class="space-y-2">
                            <button type="button" class="edit-battle-record text-blue-500 hover:text-blue-700" 
                                    data-rebel-id="${rebelId}" data-index="${index}">
                                <i class="fa fa-pencil"></i> 编辑
                            </button>
                            <button type="button" class="delete-battle-record text-red-500 hover:text-red-700" 
                                    data-rebel-id="${rebelId}" data-index="${index}">
                                <i class="fa fa-trash-o"></i> 删除
                            </button>
                        </div>
                    </div>
                    <p class="text-sm text-gray-500 mb-2">${record.date} | 镇守使功臣: ${record.defenderHero}</p>
                    <p class="text-gray-700 text-sm mb-3 line-clamp-2">${record.description}</p>
                    <div class="flex space-x-2 overflow-x-auto pb-2">
                        ${record.images.map(img => `
                            <div class="flex-shrink-0 w-20 h-20 rounded overflow-hidden">
                                <img src="${img}" alt="战役图片" class="w-full h-full object-cover" onerror="this.src='https://images.unsplash.com/photo-1519751138087-5bf79df62d5b?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=2070&q=80'; this.onerror=null;">
                            </div>
                        `).join('')}
                    </div>
                `;
                container.appendChild(recordElement);
            });
            
            // 添加编辑和删除战绩的事件监听
            document.querySelectorAll('.edit-battle-record').forEach(btn => {
                btn.addEventListener('click', function() {
                    const rebelId = parseInt(this.getAttribute('data-rebel-id'));
                    const index = parseInt(this.getAttribute('data-index'));
                    openEditBattleRecordModal(rebelId, index);
                });
            });
            
            document.querySelectorAll('.delete-battle-record').forEach(btn => {
                btn.addEventListener('click', function() {
                    const rebelId = parseInt(this.getAttribute('data-rebel-id'));
                    const index = parseInt(this.getAttribute('data-index'));
                    
                    const rebel = charactersData.rebel.find(r => r.id === rebelId);
                    if (rebel && confirm(`确定要删除"${rebel.battleRecords[index].title}"这条战绩记录吗？`)) {
                        // 从数组中删除战绩
                        rebel.battleRecords.splice(index, 1);
                        
                        // 保存数据
                        saveCharactersData();
                        
                        // 重新渲染战绩记录
                        renderBattleRecords(rebelId);
                    }
                });
            });
        }
        
        // 打开添加战绩记录模态框
        function openAddBattleRecordModal() {
            const rebelId = parseInt(document.getElementById('character-id').value);
            if (!rebelId) return;
            
            // 设置模态框标题
            document.getElementById('battle-form-title').textContent = '添加新战绩';
            
            // 清空表单
            document.getElementById('battle-record-form').reset();
            document.getElementById('battle-rebel-id').value = rebelId;
            document.getElementById('battle-record-index').value = '-1';
            
            // 清空图片容器并添加一个默认图片输入框
            const imagesContainer = document.getElementById('battle-images-container');
            imagesContainer.innerHTML = '';
            addBattleImageField();
            
            // 显示模态框
            const modal = document.getElementById('battle-record-modal');
            const modalContent = document.getElementById('battle-modal-form-content');
            
            modal.classList.remove('hidden');
            setTimeout(() => {
                modalContent.classList.remove('scale-95', 'opacity-0');
                modalContent.classList.add('scale-100', 'opacity-100');
            }, 10);
        }
        
        // 打开编辑战绩记录模态框
        function openEditBattleRecordModal(rebelId, index) {
            const rebel = charactersData.rebel.find(r => r.id === rebelId);
            if (!rebel || !rebel.battleRecords || index < 0 || index >= rebel.battleRecords.length) return;
            
            const record = rebel.battleRecords[index];
            
            // 设置模态框标题
            document.getElementById('battle-form-title').textContent = '编辑战绩';
            
            // 填充表单数据
            document.getElementById('battle-rebel-id').value = rebelId;
            document.getElementById('battle-record-index').value = index;
            document.getElementById('battle-title').value = record.title;
            document.getElementById('battle-date').value = record.date;
            document.getElementById('battle-hero').value = record.defenderHero;
            document.getElementById('battle-description').value = record.description;
            
            // 清空图片容器并添加现有图片
            const imagesContainer = document.getElementById('battle-images-container');
            imagesContainer.innerHTML = '';
            
            // 添加图片输入框
            if (record.images && record.images.length > 0) {
                record.images.forEach(img => {
                    addBattleImageField(img);
                });
            } else {
                addBattleImageField();
            }
            
            // 显示模态框
            const modal = document.getElementById('battle-record-modal');
            const modalContent = document.getElementById('battle-modal-form-content');
            
            modal.classList.remove('hidden');
            setTimeout(() => {
                modalContent.classList.remove('scale-95', 'opacity-0');
                modalContent.classList.add('scale-100', 'opacity-100');
            }, 10);
        }
        
        // 关闭战绩记录模态框
        function closeBattleRecordModal() {
            const modal = document.getElementById('battle-record-modal');
            const modalContent = document.getElementById('battle-modal-form-content');
            
            // 添加关闭动画
            modalContent.classList.remove('scale-100', 'opacity-100');
            modalContent.classList.add('scale-95', 'opacity-0');
            
            // 动画结束后隐藏模态框
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 300);
        }
        
        // 添加战绩图片输入框
        function addBattleImageField(initialValue = '') {
            const imagesContainer = document.getElementById('battle-images-container');
            const fieldCount = imagesContainer.children.length;
            
            const imageField = document.createElement('div');
            imageField.className = 'flex items-center gap-3';
            imageField.setAttribute('data-index', fieldCount);
            imageField.innerHTML = `
                <div class="flex-1">
                    <input type="url" class="battle-image-url w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-500/50" 
                           placeholder="输入图片URL" value="${initialValue}">
                </div>
                <div class="flex-shrink-0">
                    <button type="button" class="remove-battle-image p-2 text-red-500 hover:text-red-700" data-index="${fieldCount}">
                        <i class="fa fa-times"></i>
                    </button>
                </div>
            `;
            imagesContainer.appendChild(imageField);
            
            // 添加删除图片按钮事件
            imageField.querySelector('.remove-battle-image').addEventListener('click', function() {
                this.parentElement.parentElement.remove();
            });
        }
        
        // 处理图片上传
        function handleImageUpload() {
            const fileInput = document.getElementById('image-upload');
            if (!fileInput.files || fileInput.files.length === 0) return;
            
            const file = fileInput.files[0];
            
            // 验证文件类型
            if (!file.type.match('image/jpeg') && !file.type.match('image/png')) {
                alert('请上传JPG或PNG格式的图片');
                return;
            }
            
            // 验证文件大小 (5MB)
            if (file.size > 5 * 1024 * 1024) {
                alert('图片大小不能超过5MB');
                return;
            }
            
            // 创建文件阅读器
            const reader = new FileReader();
            
            reader.onload = function(e) {
                // 更新预览图片和URL输入框
                document.getElementById('character-image-preview').src = e.target.result;
                document.getElementById('character-image-url').value = e.target.result;
            };
            
            reader.readAsDataURL(file);
        }
        
        // 使用图片URL
        function useImageUrl() {
            const url = document.getElementById('character-image-url').value.trim();
            if (url) {
                document.getElementById('character-image-preview').src = url;
            }
        }
        
        // 移除图片
        function removeImage() {
            const defaultImage = 'https://images.unsplash.com/photo-1534528741775-53994a69daeb?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=764&q=80';
            document.getElementById('character-image-preview').src = defaultImage;
            document.getElementById('character-image-url').value = defaultImage;
            document.getElementById('image-upload').value = '';
        }
        
        // 保存或创建人物
        function saveOrCreateCharacter(e) {
            e.preventDefault();
            
            // 获取表单数据
            const id = document.getElementById('character-id').value;
            const faction = document.getElementById('character-faction').value;
            const name = document.getElementById('character-name').value;
            const title = document.getElementById('character-title').value;
            const description = document.getElementById('character-description').value;
            const tags = document.getElementById('character-tags').value.split(',').map(tag => tag.trim());
            const image = document.getElementById('character-image-url').value;
            
            // 验证必填字段
            if (!name || !title || !description || !tags.length || !image) {
                alert('请填写所有必填字段');
                return;
            }
            
            const isNew = document.getElementById('is-new-character').value === 'true';
            
            if (isNew) {
                // 创建新人物
                const newCharacter = {
                    id: generateNewId(),
                    name,
                    title,
                    description,
                    tags,
                    image
                };
                
                // 如果是乱臣贼子，添加空的战绩记录数组
                if (faction === 'rebel') {
                    newCharacter.battleRecords = [];
                }
                
                charactersData[faction].push(newCharacter);
            } else {
                // 更新现有人物
                const characterIndex = charactersData[faction].findIndex(char => char.id == id);
                if (characterIndex !== -1) {
                    charactersData[faction][characterIndex] = {
                        ...charactersData[faction][characterIndex],
                        name,
                        title,
                        description,
                        tags,
                        image
                    };
                }
            }
            
            // 保存数据
            saveCharactersData();
            
            // 重新计算总页数
            calculateTotalPages();
            
            // 重新渲染人物列表
            renderAdminCharactersList(faction);
            
            // 提示保存成功
            alert(isNew ? '人物添加成功！' : '人物信息更新成功！');
            
            // 如果不是新增状态，关闭管理面板
            if (!isNew) {
                closeAdminPanel();
            } else {
                // 如果是新增状态，清空表单准备添加下一个
                prepareAddNewCharacter(faction);
            }
        }
        
        // 保存战绩记录
        function saveBattleRecord(e) {
            e.preventDefault();
            
            // 获取表单数据
            const rebelId = parseInt(document.getElementById('battle-rebel-id').value);
            const recordIndex = parseInt(document.getElementById('battle-record-index').value);
            const title = document.getElementById('battle-title').value;
            const date = document.getElementById('battle-date').value;
            const defenderHero = document.getElementById('battle-hero').value;
            const description = document.getElementById('battle-description').value;
            
            // 获取所有图片URL
            const imageUrls = [];
            document.querySelectorAll('.battle-image-url').forEach(input => {
                if (input.value.trim()) {
                    imageUrls.push(input.value.trim());
                }
            });
            
            // 验证必填字段
            if (!title || !date || !defenderHero || !description || imageUrls.length === 0) {
                alert('请填写所有必填字段');
                return;
            }
            
            // 查找对应的乱臣贼子
            const rebel = charactersData.rebel.find(r => r.id === rebelId);
            if (!rebel) return;
            
            // 确保有battleRecords数组
            if (!rebel.battleRecords) {
                rebel.battleRecords = [];
            }
            
            if (recordIndex === -1) {
                // 添加新战绩
                rebel.battleRecords.push({
                    id: generateNewBattleId(),
                    title,
                    date,
                    defenderHero,
                    description,
                    images: imageUrls
                });
            } else {
                // 更新现有战绩
                rebel.battleRecords[recordIndex] = {
                    ...rebel.battleRecords[recordIndex],
                    title,
                    date,
                    defenderHero,
                    description,
                    images: imageUrls
                };
            }
            
            // 保存数据
            saveCharactersData();
            
            // 重新渲染战绩记录
            renderBattleRecords(rebelId);
            
            // 关闭模态框
            closeBattleRecordModal();
            
            // 提示保存成功
            alert(recordIndex === -1 ? '战绩添加成功！' : '战绩更新成功！');
        }
        
        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
